<!-- inject:global -->
<!-- endinject -->
<template>
    <!-- inject:html -->
    <div class="ws-week-wrapper">
  <input type="text" class="ws-week-input" readonly placeholder="week picker" /> <i class="icon icon-calendar"></i>
  <div class="ws-week-picker">
    <div class="year-selector prev-year">
      <span class="icon checkPrevYear"></span>
      <div class="year"></div>
      <div class="weeks"></div>
    </div>
    <div class="year-selector cur-year">
      <div class="year"></div>
      <div class="weeks"></div>
    </div>
    <div class="year-selector next-year">
      <div class="year"></div>
      <span class="icon checkNextYear"></span>
      <div class="weeks"></div>
    </div>
  </div>
</div>

    <!-- endinject -->
    <style>
        /* inject:styles */
        /* endinject */
    </style>
</template>

<script>
(function(){
    /* inject:js */
    'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

//Get the contents of the template (_currentScript is available with webcomponents.js, use currentScript if you don't use this Polyfill)
var currentScript = document._currentScript || document.currentScript;
var template = currentScript.ownerDocument.querySelector('template');

var WSWeekPicker = function (_HTMLElement) {
  _inherits(WSWeekPicker, _HTMLElement);

  function WSWeekPicker() {
    _classCallCheck(this, WSWeekPicker);

    return _possibleConstructorReturn(this, (WSWeekPicker.__proto__ || Object.getPrototypeOf(WSWeekPicker)).apply(this, arguments));
  }

  _createClass(WSWeekPicker, [{
    key: 'createdCallback',
    value: function createdCallback() {
      // Take all main DOM elements
      var clone = document.importNode(template.content, true);
      this.createShadowRoot().appendChild(clone);
      this.open = false;
      this.months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      this.getAttributes();
      this.getElements();
      this.addListeners();
      this.setInputValue();
    }

    // Take all elements from week picker

  }, {
    key: 'getElements',
    value: function getElements() {
      this.wrapper = this.shadowRoot.querySelector('.ws-week-wrapper');
      this.input = this.shadowRoot.querySelector('.ws-week-input');
      this.calendar = this.shadowRoot.querySelector('.ws-week-picker');
      this.crossIcon = this.shadowRoot.querySelector('input + i');
      this.prevYearButton = this.shadowRoot.querySelector('.checkPrevYear');
      this.nextYearButton = this.shadowRoot.querySelector('.checkNextYear');
      // Calculate previous year and take previous year and weeks elements
      this.prevYear = this.curYear - 1;
      this.prevYearNumber = this.shadowRoot.querySelector('.prev-year > .year');
      this.prevYearWeeks = this.shadowRoot.querySelector('.prev-year > .weeks');
      // Take current year and weeks elements
      this.curYearNumber = this.shadowRoot.querySelector('.cur-year > .year');
      this.curYearWeeks = this.shadowRoot.querySelector('.cur-year > .weeks');
      // Calculate next year and take next year and weeks elements
      this.nextYear = this.curYear + 1;
      this.nextYearNumber = this.shadowRoot.querySelector('.next-year > .year');
      this.nextYearWeeks = this.shadowRoot.querySelector('.next-year > .weeks');
    }

    // Attach all event liteners

  }, {
    key: 'addListeners',
    value: function addListeners() {
      var _this2 = this;

      document.addEventListener('click', function (e) {
        return _this2.open && e.target != _this2 ? _this2.closeWeekPicker() : null;
      });
      this.input.addEventListener('click', function (e) {
        return _this2.open ? _this2.closeWeekPicker() : _this2.openWeekPicker();
      });
      this.crossIcon.addEventListener('click', function (e) {
        return _this2.open ? _this2.closeWeekPicker() : _this2.openWeekPicker();
      });
      this.calendar.addEventListener('click', function (e) {
        return _this2.calendarClick(e);
      });
      this.prevYearButton.addEventListener('click', function () {
        return _this2.moveYearBefore();
      });
      this.nextYearButton.addEventListener('click', function () {
        return _this2.moveYearAfter();
      });
    }
  }, {
    key: 'calendarClick',
    value: function calendarClick(e) {
      // If user pick on week number take all elements to return result to input field and close calendar
      if (e.target.className == 'week' || e.target.className == 'week now') {
        if (e.target.parentElement.parentElement.parentElement.className == 'prev-year') {
          this.pickedWeekYear = e.target.parentElement.parentElement.parentElement.children[1].firstElementChild.innerHTML;
        } else {
          this.pickedWeekYear = e.target.parentElement.parentElement.parentElement.firstElementChild.firstElementChild.innerHTML;
        }
        this.pickedWeekWrapper.className = 'week';
        this.pickedWeekWrapper = e.target;
        this.pickedWeekWrapper.className = 'week now';

        var pickedDate = parseDate(this.pickedWeekYear, this.pickedWeekWrapper.innerHTML);
        this.parseDates(pickedDate);
        this.setInputValue();
        this.closeWeekPicker();
        this.propagateWeekChanges(this.selectedWeek, this.selectedYear);
      }
    }

    // build calendar year, months and week numbers

  }, {
    key: 'buildCalendar',
    value: function buildCalendar() {
      this.destroyCalendar();
      this.buildYears();
      this.buildWeeksAndMonth();
    }

    // Clean all generated elements if user change year

  }, {
    key: 'destroyCalendar',
    value: function destroyCalendar() {
      this.prevYearNumber.innerHTML = '';
      this.prevYearWeeks.innerHTML = '';
      this.curYearNumber.innerHTML = '';
      this.curYearWeeks.innerHTML = '';
      this.nextYearNumber.innerHTML = '';
      this.nextYearWeeks.innerHTML = '';
    }
  }, {
    key: 'openWeekPicker',
    value: function openWeekPicker() {
      this.open = true;
      // Prevent on every click full redraw calendar
      this.calendar.className = 'ws-week-picker opened';
      this.input.className = 'ws-week-input active';
      this.crossIcon.className = 'icon icon-cross';
      // If input clear draw calendar and define current week and select it
      if (!this.pickedWeekWrapper) {
        this.buildCalendar();
        this.highlightCurrentWeek();
      } else {
        // if input have value - define current week as selected at previous time
        this.pickedWeekWrapper.className = 'week now';
      }
    }

    // Close calendar if user don't click on calendar

  }, {
    key: 'closeWeekPicker',
    value: function closeWeekPicker() {
      this.open = false;
      this.calendar.className = 'ws-week-picker';
      this.input.className = 'ws-week-input used';
      this.crossIcon.className = 'icon icon-calendar';
    }
  }, {
    key: 'setInputValue',
    value: function setInputValue() {
      this.input.value = this.selectedWeek + '-' + this.curYear;
    }

    // Changed year if user click left arrow button

  }, {
    key: 'moveYearBefore',
    value: function moveYearBefore() {
      this.curYear -= 1;
      this.prevYear -= 1;
      this.nextYear -= 1;
      this.buildCalendar();
      this.highlightCurrentWeek();
    }

    // Changed year if user click right arrow button

  }, {
    key: 'moveYearAfter',
    value: function moveYearAfter() {
      this.curYear += 1;
      this.prevYear += 1;
      this.nextYear += 1;
      this.buildCalendar();
      this.highlightCurrentWeek();
    }

    // Draw span with year number

  }, {
    key: 'buildYears',
    value: function buildYears() {
      this.prevYearNumber.innerHTML = '<span>' + this.prevYear + '</span>';
      this.nextYearNumber.innerHTML = '<span>' + this.nextYear + '</span>';
      this.curYearNumber.innerHTML = '<span>' + this.curYear + '</span>';
    }

    // Draw months and week numbers

  }, {
    key: 'buildWeeksAndMonth',
    value: function buildWeeksAndMonth() {
      var _this3 = this;

      var self = this;
      this.prevYearWeeksNumbers = weeksNumbersForYear(this.prevYear).slice(10);
      // Draw month and it weeks in different spans
      this.prevYearWeeksNumbers.forEach(function (month, i) {
        _this3.prevYearWeeks.innerHTML += '<span class="weekNumbers">\n                                          <span class="month">' + self.months[i + 10] + '</span>\n                                          <span class="week">' + month.join('</span><span class="week">') + '</span>\n                                       </span>';
      });
      this.curYearWeeksNumbers = weeksNumbersForYear(this.curYear);
      this.curYearWeeksNumbers.forEach(function (month, i) {
        _this3.curYearWeeks.innerHTML += '<span class="weekNumbers">\n                                          <span class="month">' + self.months[i] + '</span>\n                                          <span class="week">' + month.join('</span><span class="week">') + '</span>\n                                       </span>';
      });
      this.nextYearWeeksNumbers = weeksNumbersForYear(this.nextYear).slice(0, 2);
      this.nextYearWeeksNumbers.forEach(function (month, i) {
        _this3.nextYearWeeks.innerHTML += '<span class="weekNumbers">\n                                          <span class="month">' + self.months[i] + '</span>\n                                          <span class="week">' + month.join('</span><span class="week">') + '</span>\n                                       </span>';
      });
    }

    // Highlight the current week number

  }, {
    key: 'highlightCurrentWeek',
    value: function highlightCurrentWeek() {
      if (this.selectedYear !== this.curYear) {
        return;
      }
      var wholeWeeks = this.shadowRoot.querySelectorAll('.cur-year .week');
      for (var i = 0; i < wholeWeeks.length; i++) {
        if (wholeWeeks[i].innerHTML == this.selectedWeek && wholeWeeks[i].parentElement.firstElementChild.innerHTML == this.selectedMonth) {
          this.pickedWeekWrapper = wholeWeeks[i];
          this.pickedWeekWrapper.className = 'week now';
        }
      }
    }
  }, {
    key: 'getAttributes',
    value: function getAttributes() {
      var selectedYear = parseInt(this.getAttribute('year'));
      var selectedWeek = parseInt(this.getAttribute('week'));
      this.date = selectedYear && selectedWeek ? parseDate(selectedYear, selectedWeek) : new Date();
      this.parseDates(this.date);
    }
  }, {
    key: 'parseDates',
    value: function parseDates(date) {
      this.curYear = this.selectedYear = date.getFullYear();
      this.selectedMonth = this.months[date.getMonth()];
      this.selectedWeek = getWeek(this.selectedYear, date.getMonth(), date.getDate());
    }
  }, {
    key: 'propagateWeekChanges',
    value: function propagateWeekChanges(week, year) {
      var event = new CustomEvent("change", {
        detail: {
          week: week,
          year: year
        }
      });
      this.dispatchEvent(event);
    }
  }, {
    key: 'attributeChangedCallback',
    value: function attributeChangedCallback(attrName, oldVal, newVal) {
      switch (attrName) {
        case "year":
        case "week":
          this.getAttributes();
          this.buildCalendar();
          this.setInputValue();
          break;
      }
    }
  }]);

  return WSWeekPicker;
}(HTMLElement);

//Register the element with the document


document.registerElement('ws-week-picker', WSWeekPicker);

//
// HELPERS
//
function getWeek(year, month, day) {
  var y2k = function y2k(number) {
    return number < 1000 ? number + 1900 : number;
  };
  var when = new Date(year, month, day);
  var newYear = new Date(year, 0, 1);
  var modDay = newYear.getDay();
  if (modDay == 0) modDay = 6;else modDay--;
  // Days between current day and 1st of January
  var daynum = (Date.UTC(y2k(year), when.getMonth(), when.getDate(), 0, 0, 0) - Date.UTC(y2k(year), 0, 1, 0, 0, 0)) / 1000 / 60 / 60 / 24 + 1;

  if (modDay < 4) {
    var weeknum = Math.floor((daynum + modDay - 1) / 7) + 1;
  } else {
    var weeknum = Math.floor((daynum + modDay - 1) / 7);
    if (weeknum == 0) {
      year--;
      var prevNewYear = new Date(year, 0, 1);
      var prevmodDay = prevNewYear.getDay();
      if (prevmodDay == 0) prevmodDay = 6;else prevmodDay--;
      if (prevmodDay < 4) weeknum = 53;else weeknum = 52;
    }
  }

  return weeknum;
}

function parseDate(year, week) {
  var simple = new Date(year, 0, 1 + (week - 1) * 7);
  var dow = simple.getDay();
  var ISOweekStart = simple;
  if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
  return ISOweekStart;
}

// Calculate all week numbers of year in January and save them in array
// January is explicitly to other months, because need to calculate first week of year
// It can be week number from previous year
function janWeekNumbers(year) {
  var firstMonthWeeks = [];
  var firstWeek = getWeek(year, 0, 1);
  var lastWeek = getWeek(year, 0, 31);
  if (firstWeek != 1) {
    firstMonthWeeks[0] = firstWeek;
    for (var j = 1; j <= lastWeek; j++) {
      firstMonthWeeks.push(j);
    }
  } else {
    for (var _j = 0; _j < lastWeek; _j++) {
      firstMonthWeeks.push(_j + 1);
    }
  }
  return firstMonthWeeks;
}

// Return array of all week numbers of year in month
function weekNumbersByMonth(year, month) {
  var monthWeeks = [];
  var firstWeek = getWeek(year, month, 1);
  var lastWeek = getWeek(year, month, 31);
  for (var j = firstWeek; j <= lastWeek; j++) {
    monthWeeks.push(j);
  }
  return monthWeeks;
}

// Array of all weeks in year, splited by month
function weeksNumbersForYear(year) {
  var weeks = [];
  weeks[0] = janWeekNumbers(year);
  for (var i = 1; i <= 11; i++) {
    weeks[i] = weekNumbersByMonth(year, i);
  }
  return weeks;
}
    /* endinject */
})()
</script>
