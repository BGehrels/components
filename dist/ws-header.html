<template>
    <!-- inject:html -->
    <div class="refills-patterns refills-components">
  <header class="navigation" role="banner">
    <div class="navigation-wrapper">
      <content select=".logo">
        <!-- Logo -->
      </content>
      <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">MENU</a>
      <nav role="navigation">
        <ul id="js-navigation-menu" class="navigation-menu show">
          <content select=".nav-link">
            <!-- Additional Items -->
          </content>
          <li class="nav-link more dropdown-menu">
            <a href="javascript:void(0)">
              <span id="selectedLanguageFlag" class="flag"></span>
              <span id="selectedLanguage"></span>
            </a>
            <ul class="submenu" id="languages">
            </ul>
          </li>
          <li class="nav-link" id="loggedInInfo">
          </li>
        </ul>
      </nav>
      <div class="navigation-tools">
      </div>
    </div>
  </header>
</div>
    <!-- endinject -->
    <style>
        /* inject:styles */
        @charset "UTF-8";html{box-sizing:border-box}*,*::after,*::before{box-sizing:inherit}.flag{display:inline-block;width:16px;height:11px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAWCAYAAAChWZ5EAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADuUlEQVRIibWVXWjWdRTHP/9nz6KYVG5Ggk4x3NLCUS41bEtZvlCkqwulUClNHNJFgUTtIswmUQoaEolgoxvR0JQIJS8ctCE6kprLlyYbilFT2sqs+f+9ntPF88wRCF38nw4czuH3wvmcL/zOL1FVstiyZYuUmIIIlOVxQXA+oOIB+c/7+UzVAe9TNm16GwARQUSIMRDjaAyEUHTvCTEQgsd7z+HDB7MD5HI5AE539xYKhID3Hucczjqss1g75sYYrDE0v9AElECBauB+EaqLxYNzBO/x1uKtxTmHNwZnDdZafGqwzjIx+NIAvOQt9TFS7z3qHDoarUWtRYxFrCnmBk0t4gzlPpAvBYB6h8YIzqHOo9agziG3AYrFrUXS9DaUeoeWBAAghn937RxqDGLMGEiaos4SjS2cjZ5YCgA/H6hVtEzQKIgXxMfbuQYtRohe0QDiFX0iwXSVQoE60MmCjo+IFFwlIjGgIoiEwvOMEYlaXAOtSpDFJQDAgQYP5bPJ4UgkouJIJIB6VCIqHpWAakQ1oBrABXIjkGSdhEd2PqZ3RxAHWgY2Lcw/vRdyBiSCK4PoCnl5DsQAZXDTQbJrT4fWNtTR1XmJ60MAkSiRd1bP4twHn6AxMuvdN3hzRzfqc4zcMlTX3ENTzzEuP7+SrevmJ1kayFfeN46l/R0saVnBwM8jnPphkKgJNdMqqX28ApxFp1Xy7NxqfIg0PFrFnM49cGgbu45ezKQeQK6jP+XExEUk+w8w/Uo3a5qnMzhoSRLg7AD09pMkcHVYaSnvp67rAMlbbXz+ZR8fvX86OwDAL4N/sHmojqvxIWLbe7RufKSwm/4FaQrA9su7qVjSQN+L62h67gDnfrqJsTYzAH0Dwyqid7YVK1SXL7/jlojqmQvXVVXJ4vkft35M7ewKONsP3oNzY1EEtZawcGFhvHqPOAcxkp8xieNn/qb+ysn/UYHGRg1znxztWVVVY4waYlAfgnafv5ZZgdyGLSfZ0d7DqpbjnL9wA34fxq1/FQAdKXweBVN+faaJzr3fMHlKOy+v/5p5T7dl6x7IGRN4sOou9u1ZytRDO/nzs3ZeG98CUPhInANVnlq4nwknOpiTXKNncSd1c6aChOwAq9fUsKp5BubDVnoXrGHLrXlUjouoQjJzEsnMiagq1Q9XsvqVQ3TNbOSBvXvZ+N1mXl/bmBkgP/jbMJ8u2cCRmgV8v+9bfEgJMbJ2ZQ3HTt1AQ2DpxSG++OoESOTg0U4mTBlP6/ZtXGrdDazKBPAP38BUStCEE90AAAAASUVORK5CYII=");background-position:0 0;background-repeat:no-repeat}.flag.flag-de{background-position:-16px 0}.flag.flag-en{background-position:0 -11px}header.navigation{background-color:#333;border-bottom:1px solid #1a1a1a;min-height:60px;width:100%;z-index:999}header.navigation .navigation-wrapper{max-width:1200px;margin-left:auto;margin-right:auto;position:relative;z-index:9999}header.navigation .navigation-wrapper::after{clear:both;content:"";display:table}header.navigation .navigation-wrapper::after{clear:both;content:"";display:table}header.navigation .logo{float:left;max-height:60px;padding-left:1em;padding-right:2em}header.navigation .navigation-menu-button{color:rgba(255,255,255,0.7);display:block;float:right;line-height:60px;margin:0;padding-right:1em;text-decoration:none;text-transform:uppercase}@media screen and (min-width:53.75em){header.navigation .navigation-menu-button{display:none}}header.navigation .navigation-menu-button:focus,header.navigation .navigation-menu-button:hover{color:white}header.navigation nav{float:none;min-height:60px;z-index:9999999}@media screen and (min-width:53.75em){header.navigation nav{float:left}}header.navigation ul.navigation-menu{clear:both;display:none;margin:0 auto;overflow:visible;padding:0;width:100%;z-index:9999}header.navigation ul.navigation-menu.show{display:block}@media screen and (min-width:53.75em){header.navigation ul.navigation-menu{display:inline;margin:0;padding:0}}header.navigation ul li.nav-link{background:#333;display:block;line-height:60px;overflow:hidden;padding-right:.8em;text-align:right;width:100%;z-index:9999;cursor:pointer;color:rgba(255,255,255,0.7)}header.navigation ul li.nav-link:hover{color:white}@media screen and (min-width:53.75em){header.navigation ul li.nav-link{background:transparent;display:inline;line-height:60px;text-decoration:none;width:auto}}header.navigation ul li.nav-link a{color:rgba(255,255,255,0.7);display:inline-block;text-decoration:none;box-sizing:content-box}@media screen and (min-width:53.75em){header.navigation ul li.nav-link a{padding-right:1em}}header.navigation ul li.nav-link a:focus,header.navigation ul li.nav-link a:hover{color:white}header.navigation ul li.nav-link a:after{position:relative !important}header.navigation li.more.nav-link{padding-right:0}@media screen and (min-width:53.75em){header.navigation li.more.nav-link{padding-right:1em}}header.navigation li.more.nav-link>ul>li:first-child a{padding-top:1em}header.navigation li.more.nav-link a{margin-right:1em}header.navigation li.more.nav-link>a{padding-right:.6em}header.navigation li.more.nav-link>a:after{position:absolute;top:auto;right:-0.4em;bottom:auto;left:auto;content:'\25BE';color:rgba(255,255,255,0.7)}header.navigation li.more{overflow:visible;padding-right:0}header.navigation li.more a{padding-right:.8em}header.navigation li.more>a{padding-right:1.6em;position:relative}@media screen and (min-width:53.75em){header.navigation li.more>a{margin-right:1em}}header.navigation li.more>a:after{content:'â€º';font-size:1.2em;position:absolute;right:.5em}header.navigation li.more:focus>.submenu,header.navigation li.more:hover>.submenu{display:block}@media screen and (min-width:53.75em){header.navigation li.more{padding-right:.8em;position:relative}}header.navigation .dropdown-menu .flag{margin-top:25px}header.navigation ul.submenu{display:none;padding-left:0}@media screen and (min-width:53.75em){header.navigation ul.submenu{left:-1em;position:absolute;top:1.5em}}@media screen and (min-width:53.75em){header.navigation ul.submenu .submenu{left:11.8em;top:0}}header.navigation ul.submenu li{display:block;padding-right:0}@media screen and (min-width:53.75em){header.navigation ul.submenu li{line-height:46.15385px}header.navigation ul.submenu li:first-child>a{border-top-left-radius:4px;border-top-right-radius:4px}header.navigation ul.submenu li:last-child>a{border-bottom-left-radius:4px;border-bottom-right-radius:4px;padding-bottom:.7em}}header.navigation ul.submenu li a{background-color:#2b2b2b;display:inline-block;text-align:right;width:100%;padding-top:0 !important}@media screen and (min-width:53.75em){header.navigation ul.submenu li a{background-color:#333;padding-left:1em;text-align:left;width:12em}}header.navigation .navigation-tools{background:#505050;clear:both;display:block;height:60px}@media screen and (min-width:53.75em){header.navigation .navigation-tools{background:transparent;clear:none;float:right}}::content .logo{float:left;max-height:60px;padding-left:1em;padding-right:2em;line-height:60px;padding-top:0;background-color:transparent;color:#00abf2;text-decoration:none;transition:color .1s linear}::content .logo img{padding:1.2em 0;height:20px}::content .logo>span{display:block;float:right;margin-left:10px}::content .logo img{padding:1.2em 0}::content li.nav-link{background:transparent;display:inline;line-height:60px;text-decoration:none;width:auto}::content li.nav-link a{padding-right:1em;color:rgba(255,255,255,0.7);display:inline-block;text-decoration:none}
        /* endinject */
    </style>
</template>

<script>
{
    /* inject:js */
    //Get the contents of the template (_currentScript is available with webcomponents.js, use currentScript if you don't use this Polyfill)
var template = document.currentScript.ownerDocument.querySelector('template');
var availableLanguages = ['de','en'];
var state = {
    tokenName: "zalando-internal-access_token",
    stateName: "zalando-internal-access_state",
    languageName: 'language',
    cookiePath: '/',
    cookieDomain: '.zalan.do',
    lang: null,
    loggedIn: null,
    clientId: null,
    redirectUrl: null,
    userServiceUrl: null,
    tokenInfoUrl: null,
}

class WSHeader extends HTMLElement {
    // Use createdCallback instead of constructor to init an element.
    createdCallback() {
        let clone = document.importNode(template.content, true);

        // This element uses Shadow DOM.
        this.createShadowRoot().appendChild(clone);

        this.state = state;
        this.getAttributes();

        this.setupLanguages();

        // would fire initial before
        document.addEventListener("DOMContentLoaded", () => {
            let lang = this.getLanguage();
            this.setLanguage(lang);

            this.checkIsLoggedIn()
            .then(() => this.getTokenInfo())
            .then(() => this.getUser())
            .then(() => this.showUser())
            .catch(() => this.propagateError("Getting Token-/User-Info failed!"));
        });
    }

    propagateError(reason) {
        let event = new CustomEvent("error", {
                detail: {
                    message: reason
                }
            });
        this.dispatchEvent(event);
    }

    getAttributes() {
        this.state = Object.assign({}, this.state, {
            clientId: this.getAttribute('client-id'),
            redirectUrl: this.getAttribute('redirect-url'),
            userServiceUrl: this.getAttribute('userservice-url'),
            tokenInfoUrl: this.getAttribute('tokeninfo-url'),
        });
    }

    setupLanguages() {
        let languagesElem = this.shadowRoot.querySelector('#languages');

        availableLanguages.map((lang) => {
            let dummy = document.createElement( 'div' );
            dummy.innerHTML = `<li>
                <a><span class="flag flag-${lang}"></span> <span translate="global.language.{{lang}}">${lang}</span></a>
            </li>`;
            let node = dummy.childNodes[0];
            node.addEventListener("click", () => this.setLanguage(lang));
            languagesElem.appendChild(node);
        });
    }

    getLanguage() {
        return this.state.lang || window.localStorage.getItem(this.state.languageName) || availableLanguages[0];
    }

    setLanguage(lang) {
        if (this.state.lang != lang) {
            this.state.lang = lang;
            window.localStorage.setItem(this.state.languageName, lang);
            this.showLanguage(lang);
            this.propagateLanguageChange(lang);
        }
    }

    showLanguage(lang) {
        this.shadowRoot.querySelector('#selectedLanguageFlag').className = "flag flag-" + lang;
        this.shadowRoot.querySelector('#selectedLanguage').innerText = lang;
    }

    propagateLanguageChange(lang) {
        let event = new CustomEvent("language-changed", {
            detail: {
                language: lang
            }
        });
        this.dispatchEvent(event);
    }

    login() {
        let url = "https://auth.zalando.com/z/oauth2/authorize?realm=employees&response_type=token&scope=uid" +
        "&client_id=" + this.state.clientId +
        "&redirect_uri=" + this.state.redirectUrl +
        "&this.state=" + this.setSessionState();

        window.location.href = url;
    }

    logout() {
        this.removeCookie();

        this.showLoggedOut();
        this.propagateLoginStatusChange(false);
    }

    checkIsLoggedIn() {
        return new Promise((resolve, reject) => {
            this.getToken(window.location.href)
            .then((token) => {
                this.showLoggedIn();

                this.propagateLoginStatusChange(true, token);
                resolve();
            }, () => {
                this.showLoggedOut();

                this.propagateLoginStatusChange(false);
                reject();
            });
        });
    }

    propagateLoginStatusChange(isLoggedIn, token) {
        if(this.state.loggedIn !== isLoggedIn){
            this.state.loggedIn = isLoggedIn;

            let event = new CustomEvent("login-status-changed", {
                detail: {
                    loggedIn: isLoggedIn,
                    token: token || null
                }
            });
            this.dispatchEvent(event);
        }
    }

    showLoggedOut() {
        let loggedInInfo = this.shadowRoot.querySelector('#loggedInInfo');
        loggedInInfo.innerHTML =
            `<a class="auto-size"><span translate="global.menu.signein">Login</span></i></a>`;
        loggedInInfo.removeEventListener("click", this.logout);
        loggedInInfo.addEventListener("click", this.login.bind(this));
    }

    showLoggedIn() {
        let loggedInInfo = this.shadowRoot.querySelector('#loggedInInfo');
        loggedInInfo.innerHTML =
            `<span translate="global.menu.signedinas"></span>
            <span id="userName">Loading...</span>
            <a class="auto-size"><i class="fa fa-power-off fa-1x"></i></a>`;
        loggedInInfo.removeEventListener("click", this.login);
        loggedInInfo.addEventListener("click", this.logout.bind(this));
    }

    setSessionState() {
        // create new state guid
        let state = this.guid();

        // save the state to check for it on return
        window.localStorage.setItem(this.state.stateName, state);
        return state;
    }

    checkSessionState(state) {
        let valid = window.localStorage.getItem(this.state.stateName) === state;
        window.localStorage.removeItem(this.state.stateName);
        return valid;
    }

    getToken(url) {
        return new Promise((resolve, reject) => {
            var token = this.getTokenFromUrl(url);
            if (token) {
                var sessionState = this.getStateFromUrl(url);
                if (this.checkSessionState(sessionState)) {
                    this.setCookie(token);
                    return resolve(token);
                }
            }
            token = this.getCookieValue(this.state.tokenName);
            if (token) {
                this.setCookie(token);
                return resolve(token);
            }

            reject();
        });
    }

    getTokenFromUrl(url) {
        let urlQueryTokenPart = /access_token=([^&]+)/.exec(url);
        return urlQueryTokenPart != null ? urlQueryTokenPart[1] : null;
    }

    getStateFromUrl(url) {
        let urlQueryStatePart = /state=([^&]+)/.exec(url);
        return urlQueryStatePart[1];
    }

    getTokenInfo() {
        return new Promise((resolve, reject) => {
            this.request('GET', this.state.tokenInfoUrl)
            .then((data) => {
                this.state = Object.assign({}, this.state, {
                    userUID: data.uid
                });
                resolve(data.uid);
            }, () => {
                this.logout();
                reject();
            });
        });
    }

    getUser() {
        return new Promise((resolve, reject) => {
        this.request('GET', `${this.state.userServiceUrl}?q=${this.state.userUID}`)
        .then((data) => {
            let user = data[0];
            let userInfo = {
                userName: user.name,
                userEmail: user.email
            };
            this.state = Object.assign({}, this.state, userInfo);
            resolve(userInfo);
        }, () => {
            this.logout();
            reject();
        });
        });
    }

    showUser() {
        this.shadowRoot.querySelector('#userName').innerText = this.state.userName;
    }

    setCookie(token) {
        // setting domain does not work for dev localhost environment
        //document.cookie = `${this.state.tokenName}=${token},path=${this.state.cookiePath};domain=${this.state.cookieDomain};`
        document.cookie = `${this.state.tokenName}=${token};path=${this.state.cookiePath};`
    }

    removeCookie() {
        document.cookie = `${this.state.tokenName}=;path=${this.state.cookiePath};domain=${this.state.cookieDomain};expires=Thu, 01 Jan 1970 00:00:01 GMT";`
    }

    // HELPERS

    // matches a cookie name in the cookie string and returns the last value
    getCookieValue(a) {
        let b = document.cookie.match('(^|;)\\s*' + a + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    guid() {
        function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }
        return `${s4()}${s4()}-${s4()}-${s4()}-${s4()}-${s4()}${s4()}${s4()}`;
    }

    // Method: 'GET', 'POST'
    request(method, url) {
        let headers = new Headers();
        return this.getToken(window.location.href)
        .then((token) => {
            headers.append("Authorization", `Bearer ${token}`);
            return Promise.resolve();
        })
        .then(() => {
            return fetch(url, {
                method: method,
                headers: headers,
                mode: 'cors',
                cache: 'default'
            })
            .then(function(response) {
                return response.json();
            });
        });
    }

    // You can also define the other lifecycle methods.
    attachedCallback() { }
    detachedCallback() { }
    attributeChangedCallback(attrName, oldVal, newVal) {
        switch (attrName) {
            case "redirect-url":
            case "client-id":
            case "userservice-url":
                this.getAttributes();
                break;
        }
    };
}


//Register the element with the document
document.registerElement('ws-header', WSHeader);
    /* endinject */
}
</script>
